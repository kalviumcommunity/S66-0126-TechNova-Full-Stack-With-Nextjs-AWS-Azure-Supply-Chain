// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and user management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings    Booking[]
  reports     Report[]
  parkingLots ParkingLot[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  PARKING_OWNER
}

// ParkingLot model for parking lot information
model ParkingLot {
  id           String   @id @default(cuid())
  name         String
  address      String
  city         City
  latitude     Float
  longitude    Float
  totalSpots   Int
  pricePerHour Float
  amenities    String[] // Array of amenities like ["CCTV", "Security", "Covered"]
  imageUrl     String?
  isActive     Boolean  @default(true)
  ownerId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  parkingSpots ParkingSpot[]
  reports      Report[]

  // Performance indexes for common queries
  @@index([city]) // Filter by city
  @@index([latitude, longitude]) // Geospatial queries for nearby parking
  @@index([ownerId]) // Owner's parking lots
  @@index([city, isActive]) // Active lots by city
  @@index([pricePerHour]) // Price-based filtering
  @@map("parking_lots")
}

enum City {
  MUMBAI
  DELHI
  BANGALORE
  PUNE
  CHENNAI
}

// ParkingSpot model for individual parking spots
model ParkingSpot {
  id           String          @id @default(cuid())
  parkingLotId String
  spotNumber   String
  type         VehicleType
  status       SpotStatus      @default(AVAILABLE)
  lastUpdated  DateTime        @default(now())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  parkingLot ParkingLot @relation(fields: [parkingLotId], references: [id], onDelete: Cascade)
  bookings   Booking[]
  sensor     Sensor?

  @@unique([parkingLotId, spotNumber])
  // Performance indexes for availability queries
  @@index([parkingLotId]) // Spots by parking lot
  @@index([status]) // Filter by availability status
  @@index([parkingLotId, status]) // Composite: available spots in a lot
  @@index([type, status]) // Filter by vehicle type and availability
  @@index([lastUpdated]) // Recent status changes
  @@map("parking_spots")
}

enum VehicleType {
  TWO_WHEELER
  FOUR_WHEELER
}

enum SpotStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

// Booking model for parking spot reservations
model Booking {
  id             String        @id @default(cuid())
  userId         String
  parkingSpotId  String
  startTime      DateTime
  endTime        DateTime
  status         BookingStatus @default(PENDING)
  totalPrice     Float
  paymentStatus  PaymentStatus @default(PENDING)
  paymentMethod  String?
  transactionId  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  parkingSpot ParkingSpot @relation(fields: [parkingSpotId], references: [id], onDelete: Cascade)

  // Performance indexes for booking queries
  @@index([userId]) // User's bookings
  @@index([parkingSpotId]) // Spot's booking history
  @@index([startTime, endTime]) // Time-based queries
  @@index([status]) // Filter by booking status
  @@index([userId, status]) // User's active/pending bookings
  @@index([createdAt]) // Recent bookings
  @@index([paymentStatus]) // Filter by payment status
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Report model for crowd-sourced parking availability reports
model Report {
  id           String     @id @default(cuid())
  userId       String
  parkingLotId String
  reportType   ReportType
  description  String?
  isVerified   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  parkingLot ParkingLot @relation(fields: [parkingLotId], references: [id], onDelete: Cascade)

  // Performance indexes for report queries
  @@index([parkingLotId]) // Reports for a parking lot
  @@index([createdAt]) // Recent reports (time-series)
  @@index([userId]) // User's report history
  @@index([reportType]) // Filter by report type
  @@index([parkingLotId, createdAt]) // Recent reports for a lot
  @@index([isVerified]) // Filter verified reports
  @@map("reports")
}

enum ReportType {
  AVAILABILITY
  FULL
  ISSUE
  PRICE_UPDATE
}

// Sensor model for IoT sensor data simulation
model Sensor {
  id             String       @id @default(cuid())
  parkingSpotId  String       @unique
  sensorType     SensorType   @default(ULTRASONIC)
  status         SensorStatus @default(ACTIVE)
  batteryLevel   Int          @default(100)
  lastPing       DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  parkingSpot ParkingSpot @relation(fields: [parkingSpotId], references: [id], onDelete: Cascade)

  // Performance indexes for sensor monitoring
  @@index([status]) // Filter by sensor status
  @@index([lastPing]) // Detect inactive sensors
  @@index([parkingSpotId]) // Sensor for a specific spot
  @@index([batteryLevel]) // Low battery alerts
  @@index([status, lastPing]) // Active sensors with recent pings
  @@map("sensors")
}

enum SensorType {
  ULTRASONIC
  INFRARED
  MAGNETIC
  CAMERA
}

enum SensorStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  ERROR
}
